# Estafette CI GKE extension

This extension makes it easy to deploy an application to GKE, and automatically handles getting the right credentials, implementing a number of best practices and more.

* [Usage](#usage)
* [Parameters](#parameters)
* [Visibility](#visibility)

# Usage

To use it you can pass a minimal number of parameters and have it create a deployment for you.

```yaml
releases:
  dev:
    stages:
      deploy:
        image: extensions/gke:stable
        container:
          repository: extensions
        hosts:
        - gke.estafette.io
```

But there's many more parameters to control the kind of resource it creates - deployment, cronjob, job, statefulset - and many other things to tune.

# Parameters

## Global parameters

These parameters apply to any of the `kind` values.

| Parameter                 | Allowed values                                                                                                                                                          | Default value                                                      | Description                                                                                                         |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------| -------------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `credentials`             | string                                                                                                                                                                  | `gke-${ESTAFETTE_RELEASE_NAME}`                                    | Is automatically generated from the release name prefixed by `gke-`                                                 |
| `action`                  | `deploy-simple`, `deploy-canary`, `deploy-stable`, `restart-simple`, `restart-canary`, `restart-stable`, `diff-simple`, `diff-canary`, `diff-stable`, `rollback-canary` | `deploy-simple`                                                    | Controls what action is taken; can take values from Estafette release actions                                       |
| `kind`                    | `deployment`, `headless-deployment`, `statefulset`, `job`, `cronjob`, `config`, `config-to-file`                                                                        | `deployment`                                                       | Determines the type of Kubernetes resource to get created                                                           |
| `dryrun`                  | bool                                                                                                                                                                    | false                                                              | Controls whether the changes generated by this extension will be applied                                            |
| `app`                     | string                                                                                                                                                                  | `${ESTAFETTE_LABEL_APP}` if set, `${ESTAFETTE_GIT_NAME}` otherwise | The name used to deploy the application                                                                             |
| `namespace`               | string                                                                                                                                                                  | empty, but usually set in the credential defaults                  | Sets the kubernetes namespace to deploy to                                                                          |

Note: the `action` should preferably not be set directly on the stage, but as actions on the stage, so you can trigger every action from estafette using the same stage:

```yaml
releases:
  prd:
    actions:
    - name: deploy-canary
    - name: deploy-stable
    - name: rollback-canary
      hideBadge: true
    - name: restart-stable
      hideBadge: true
    stages:
      deploy:
        image: extensions/gke:stable
        kind: deployment
```

## Application container parameters

For any of the `kind` values except for `config` and `config-to-file` these set the values for the main application container with sensible defaults. Try to match your application port and endpoints as much as possible to the defaults so you have to override the bare minimum.

| Parameter                                 | Allowed values                                                                                                            | Default value                                     | Description                                                                                                                                                                  |
| ----------------------------------------- | --------------------------------------------------------------------------------------------------------------------------| ------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `container.repository`                    | docker repository without image name                                                                                      |                                                   | Path for the image repository minus the last part, for example `extensions` for `extensions/gke` image, or `gcr.io/<project id>`                                             |
| `container.name`                          | docker image name                                                                                                         | `app` value                                       | The name of the container image, usually `${ESTAFETTE_LABEL_APP}` or `${ESTAFETTE_GIT_NAME}`                                                                                 |
| `container.tag`                           | docker image tag                                                                                                          | `${ESTAFETTE_BUILD_VERSION}`                      | The container image tag, usually the build version                                                                                                                           |
| `container.port`                          | int                                                                                                                       | `5000`                                            | The port the main container listens on; preferably port 5000 so you don't have to explicitly set it                                                                          |
| `container.env`                           | map of environment variable keys and values                                                                               |                                                   | A map of environment variable keys and values, passed on to the container                                                                                                    |
| `container.secretEnv`                     | map of environment variable keys and secret values                                                                        |                                                   | Same as `env` but the values are stored in a secret instead and referenced with `secretKeyRef` automatically; no need to base64 encode                                       |
| `container.cpu.request`                   | [kubernetes cpu spec](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu)      | `100m`                                            | The cpu request value; this ensures the application has at least the cpu required to operate under normal circumstances and is used for calculating the autoscaling cpu load |
| `container.cpu.limit`                     | [kubernetes cpu spec](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu)      |                                                   | The cpu limit; no need to set, it can lead to cpu throttling, but in case your application turns out to be a noisy neighbour can be set                                      |
| `container.memory.request`                | [kubernetes memoy spec](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory) | `128Mi`                                           | The requested memory; setting it lower than the limit can lead to _out of memory kill_ before hitting the limit if the node it runs on is short on memory                    |
| `container.memory.limit`                  | [kubernetes memoy spec](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory) | `128Mi`                                           | The memory limit; when a container hits this limit it's killed with an _out of memory kill_; set equal to request for guaranteed Quality of Service                          |
| `container.liveness.enabled`              | bool                                                                                                                      | `true`                                            |                                                                                                                                                                              |
| `container.liveness.path`                 | string                                                                                                                    | `/liveness`                                       |                                                                                                                                                                              |
| `container.liveness.port`                 | int                                                                                                                       | `container.port`                                  |                                                                                                                                                                              |
| `container.liveness.delay`                | int                                                                                                                       | `30`                                              |                                                                                                                                                                              |
| `container.liveness.timeout`              | int                                                                                                                       | `1`                                               |                                                                                                                                                                              |
| `container.liveness.period`               | int                                                                                                                       | `10`                                              |                                                                                                                                                                              |
| `container.liveness.failureThreshold`     | int                                                                                                                       | `3`                                               |                                                                                                                                                                              |
| `container.liveness.successThreshold`     | int                                                                                                                       | `1`                                               |                                                                                                                                                                              |
| `container.readiness.enabled`             | bool                                                                                                                      | `true`                                            |                                                                                                                                                                              |
| `container.readiness.path`                | string                                                                                                                    | `/readiness`                                      |                                                                                                                                                                              |
| `container.readiness.port`                | int                                                                                                                       | `container.port`                                  |                                                                                                                                                                              |
| `container.readiness.delay`               | int                                                                                                                       | `0`                                               |                                                                                                                                                                              |
| `container.readiness.timeout`             | int                                                                                                                       | `1`                                               |                                                                                                                                                                              |
| `container.readiness.period`              | int                                                                                                                       | `10`                                              |                                                                                                                                                                              |
| `container.readiness.failureThreshold`    | int                                                                                                                       | `3`                                               |                                                                                                                                                                              |
| `container.readiness.successThreshold`    | int                                                                                                                       | `1`                                               |                                                                                                                                                                              |
| `container.metrics.scrape`                | bool                                                                                                                      | `true`                                            |                                                                                                                                                                              |
| `container.metrics.path`                  | string                                                                                                                    | `/metrics`                                        |                                                                                                                                                                              |
| `container.metrics.port`                  | int                                                                                                                       | `container.port`                                  |                                                                                                                                                                              |
| `container.lifecycle.prestopsleep`        | bool                                                                                                                      | `true` for `os: linux`, `false` for `os: windows` |                                                                                                                                                                              |
| `container.lifecycle.prestopsleepseconds` | int                                                                                                                       | `20`                                              |                                                                                                                                                                              |
| `container.additionalports[].name`        | string                                                                                                                    |                                                   |                                                                                                                                                                              |
| `container.additionalports[].port`        | int                                                                                                                       |                                                   |                                                                                                                                                                              |
| `container.additionalports[].protocol`    | `TCP` or `UDP`                                                                                                            | `TCP`                                             |                                                                                                                                                                              |
| `container.additionalports[].visibility`  | see `visibility`                                                                                                          | `visibility`                                      |                                                                                                                                                                              |

## Deployment parameters

Specific to kind `deployment`

| Parameter                                      | Allowed values                                                           | Default value                                                                                         | Description                                                                                                         |
| ---------------------------------------------- | ------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| `replicas`                                     | int                                                                      | `1`                                                                                                   | The number of pods to run                                                                                           |
| `visibility`                                   | `private`, `public`, `public-whitelist`, `esp`, `espv2`, `iap`, `apigee` | `private`                                                                                             | Determines how the application can be reached                                                                       |
| `iapOauthClientID`                             | string (base64 encoded)                                                  |                                                                                                       | Needs a Google OAuth Client ID encoded in base64 when using `visibility: iap`; has to be created in advance         |
| `iapOauthClientSecret`                         | string (base64 encoded)                                                  |                                                                                                       | Needs a Google OAuth Client Secret encoded in base64 when using `visibility: iap`; has to be created in advance     |
| `espEndpointsProjectID`                        | string                                                                   |                                                                                                       | When Google Cloud Endpoints are set up in a centralized project set it's ID with this parameter                     |
| `espConfigID`                                  | string                                                                   | Takes the latest openapi spec uploaded by this extension                                              | When you want to pin the version of the openapi spec uploaded as a Google Cloud Endpoint config it can be set       |
| `espOpenapiYamlPath`                           | string                                                                   |                                                                                                       | Path to `openapi.yaml` file to use for creating the endpoint config; use separate ones per environment              |
| `whitelist`                                    | []string                                                                 | The default configured in the `nginx-office` controller                                               | A list of [CIDRs][https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing] to allow access to the application  |
| `progressDeadlineSeconds`                      | int                                                                      | `600`                                                                                                 | Sets the number of seconds for Kubernetes to wait for a deployment to lack progress before treating it as a failure |
| `os`                                           | `linux`, `windows`                                                       | `linux`                                                                                               | The operating system to deploy to                                                                                   |
| `chaosproof`                                   | bool                                                                     | `false`                                                                                               | Determines whether it's okay to run the application on preemptibles                                                 |
| `manifests.files`                              | []string                                                                 |                                                                                                       |                                                                                                                     |
| `manifests.data`                               | map[string]interface{}                                                   |                                                                                                       |                                                                                                                     |
| `trustedips`                                   | []string                                                                 |                                                                                                       |                                                                                                                     |
| `labels`                                       | map[string]string                                                        |                                                                                                       |                                                                                                                     |
| `containerNativeLoadBalancing`                 | bool                                                                     |                                                                                                       |                                                                                                                     |
| `hosts`                                        | []string                                                                 |                                                                                                       |                                                                                                                     |
| `hostsrouteonly`                               | []string                                                                 |                                                                                                       |                                                                                                                     |
| `internalhosts`                                | []string                                                                 |                                                                                                       |                                                                                                                     |
| `internalhostsrouteonly`                       | []string                                                                 |                                                                                                       |                                                                                                                     |
| `apigeesuffix`                                 | string                                                                   | `apigee`                                                                                              |                                                                                                                     |
| `basepath`                                     | string                                                                   | `/`                                                                                                   |                                                                                                                     |
| `autoscale.enabled`                            | bool                                                                     | `true`                                                                                                |                                                                                                                     |
| `autoscale.min`                                | int                                                                      | `3`                                                                                                   |                                                                                                                     |
| `autoscale.max`                                | int                                                                      | `100`                                                                                                 |                                                                                                                     |
| `autoscale.cpu`                                | int                                                                      | `80`                                                                                                  |                                                                                                                     |
| `autoscale.safety.enabled`                     | bool                                                                     | `false`                                                                                               |                                                                                                                     |
| `autoscale.safety.promquery`                   | string                                                                   | `sum(rate(nginx_http_requests_total{app='%v'}[5m])) by (app)`                                         |                                                                                                                     |
| `autoscale.safety.ratio`                       | string                                                                   | `1`                                                                                                   |                                                                                                                     |
| `autoscale.safety.delta`                       | string                                                                   |                                                                                                       |                                                                                                                     |
| `autoscale.safety.scaledownratio`              | string                                                                   | `1`                                                                                                   |                                                                                                                     |
| `request.timeout`                              | string                                                                   | `60s`                                                                                                 |                                                                                                                     |
| `request.maxbodysize`                          | string                                                                   | `128m`                                                                                                |                                                                                                                     |
| `request.proxybuffersize`                      | string                                                                   | `4k`                                                                                                  |                                                                                                                     |
| `request.proxybuffersnumber`                   | int                                                                      | `4`                                                                                                   |                                                                                                                     |
| `request.clientbodybuffersize`                 | string                                                                   | `8k`                                                                                                  |                                                                                                                     |
| `request.loadbalance`                          | `ewma`, `round_robin`                                                    | `round_robin`                                                                                         |                                                                                                                     |
| `request.authsecret`                           | string                                                                   |                                                                                                       |                                                                                                                     |
| `request.verifydepth`                          | int                                                                      | `3`                                                                                                   |                                                                                                                     |
| `secrets.keys`                                 | map[string]interface{}                                                   |                                                                                                       |                                                                                                                     |
| `secrets.mountpath`                            | string                                                                   |                                                                                                       |                                                                                                                     |
| `configs.files`                                | []string                                                                 |                                                                                                       |                                                                                                                     |
| `configs.data`                                 | map[string]interface{}                                                   |                                                                                                       |                                                                                                                     |
| `configs.inline`                               | map[string]string                                                        |                                                                                                       |                                                                                                                     |
| `configs.mountpath`                            | string                                                                   |                                                                                                       |                                                                                                                     |
| `volumemounts[].name`                          | string                                                                   |                                                                                                       |                                                                                                                     |
| `volumemounts[].mountpath`                     | string                                                                   |                                                                                                       |                                                                                                                     |
| `volumemounts[].volume`                        | map[string]interface{}                                                   |                                                                                                       |                                                                                                                     |
| `certificatesecret`                            | string                                                                   |                                                                                                       |                                                                                                                     |
| `allowhttp`                                    | bool                                                                     | `false`                                                                                               |                                                                                                                     |
| `enablePayloadLogging`                         | bool                                                                     | `false`                                                                                               |                                                                                                                     |
| `useGoogleCloudCredentials`                    | bool                                                                     | `false`                                                                                               |                                                                                                                     |
| `disableServiceAccountKeyRotation`             | bool                                                                     | `true`                                                                                                |                                                                                                                     |
| `legacyGoogleCloudServiceAccountKeyFile`       | string                                                                   |                                                                                                       |                                                                                                                     |
| `googleCloudCredentialsApp`                    | string                                                                   |                                                                                                       |                                                                                                                     |
| `probeService`                                 | bool                                                                     | `false` for `visibility: esp` and `visibility: espv2`, `true` otherwise                               |                                                                                                                     |
| `tolerations`                                  | []yaml snippet                                                           |                                                                                                       |                                                                                                                     |
| `injecthttpproxysidecar`                       | bool                                                                     | `true`                                                                                                |                                                                                                                     |
| `initcontainers`                               | []yaml snippet                                                           |                                                                                                       |                                                                                                                     |
| `sidecar`                                      | *deprecated*, use `sidecars` parameter instead                           |                                                                                                       |                                                                                                                     |
| `sidecars[].type`                              | `openresty`, `esp`, `espv2`, `cloudsqlproxy`, `istio`                    |                                                                                                       |                                                                                                                     |
| `sidecars[].image`                             | string                                                                   |                                                                                                       |                                                                                                                     |
| `sidecars[].env`                               | map[string]interface{}                                                   |                                                                                                       |                                                                                                                     |
| `sidecars[].secretEnv`                         | map[string]interface{}                                                   |                                                                                                       |                                                                                                                     |
| `sidecars[].cpu.request`                       | string                                                                   | `50m`                                                                                                 |                                                                                                                     |
| `sidecars[].cpu.limit`                         | string                                                                   |                                                                                                       |                                                                                                                     |
| `sidecars[].memory.request`                    | string                                                                   | `30m`                                                                                                 |                                                                                                                     |
| `sidecars[].memory.limit`                      | string                                                                   | `50m`                                                                                                 |                                                                                                                     |
| `sidecars[].healthcheckpath`                   | string                                                                   | `container.readiness.path`                                                                            |                                                                                                                     |
| `sidecars[].dbinstanceconnectionname`          | string                                                                   |                                                                                                       |                                                                                                                     |
| `sidecars[].sqlproxyport`                      | int                                                                      | `5432`                                                                                                |                                                                                                                     |
| `sidecars[].sqlproxyterminationtimeoutseconds` | int                                                                      | `60`                                                                                                  |                                                                                                                     |
| `customsidecars`                               | []yaml snippet                                                           |                                                                                                       |                                                                                                                     |
| `strategytype`                                 | `RollingUpdate`, `Recreate`, `AtomicUpdate`                              |                                                                                                       |                                                                                                                     |
| `rollingupdate.maxsurge`                       | string                                                                   | `25%`                                                                                                 |                                                                                                                     |
| `rollingupdate.maxunavailable`                 | string                                                                   | `0`                                                                                                   |                                                                                                                     |
| `rollingupdate.timeout`                        | string                                                                   | `5m`                                                                                                  |                                                                                                                     |
| `defaultOpenrestySidecarImage`                 | string                                                                   | `estafette/openresty-sidecar@sha256:2aa9f2c8c3f506e0f6cc70871701b5ac81aa0f12e8574c7b8213e4d0379d2ddd` |                                                                                                                     |
| `defaultESPSidecarImage`                       | string                                                                   | `gcr.io/endpoints-release/endpoints-runtime:1.56.0`                                                   |                                                                                                                     |
| `defaultESPv2SidecarImage`                     | string                                                                   | `gcr.io/endpoints-release/endpoints-runtime:2.25.0`                                                   |                                                                                                                     |
| `defaultCloudSQLProxySidecarImage`             | string                                                                   | `eu.gcr.io/cloudsql-docker/gce-proxy:1.17`                                                            |                                                                                                                     |
| `imagePullSecretUser`                          | string                                                                   |                                                                                                       |                                                                                                                     |
| `imagePullSecretPassword`                      | string                                                                   |                                                                                                       |                                                                                                                     |

Note: for `visibility: esp` a release needs access to the openapi spec, so combine with `clone: true` on the release target, for example:

```yaml
releases:
  dev:
    clone: true
    stages:
      deploy:
        image: extensions/gke:stable
        visibility: esp
        espOpenapiYamlPath: openapi.dev.yaml
```

## Statefulset parameters

Specific to kind `statefulset`

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `storageclass`            | `standard`, `pd-standard`, `pd-ssd`                                                                                                                 | `standard`                                                     | Determines the type of persistent disk created                                                                      |
| `storagesize`             | string                                                                                                                                              | `1Gi`                                                          | The size of the persistent disk                                                                                     |
| `storagemountpath`        | string                                                                                                                                              | `/data`                                                        | The path where the persistent disk is mounted                                                                       |

## Cronjob parameters

Specific to kind `cronjob`

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `schedule`                | string                                                                                                                                              |                                                                | Sets the schedule at which the cronjob spawns a new job                                                             |
| `concurrencypolicy`       | `Allow`, `Forbid`                                                                                                                                   | `Allow`                                                        | Indicates whether concurrent jobs are allowed or forbidden                                                          |

## Cronjob/Job parameters

Specific to kind `cronjob` and `job`

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `completions`             | int                                                                                                                                                 | `1`                                                            |                                                                                                                     |
| `parallelism`             | int                                                                                                                                                 | `1`                                                            |                                                                                                                     |
| `backoffLimit`            | int                                                                                                                                                 | `6`                                                            |                                                                                                                     |
| `restartPolicy`           | `Always`, `OnFailure`                                                                                                                               | `OnFailure`                                                    | Controls whether a container should be restarted when it stops                                                      |


# Visibility

How the customers of an application - whether it's an actual user connecting or another service - can communicate with your application is set by the `visibility` parameter. 

| Value              | Description                                                                                                                                                                                                                                                     |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `private`          | A Kubernetes service of type `ClusterIP` is created and depending on the values for `hosts` and `internalhosts` it also sets up ingresses using ingress class `nginx-office` and/or `nginx-internal`                                                            |
| `public`           | A `LoadBalancer` Kubernetes service is created which gives direct public access to the application; this is no longer allowed for new deployments, `esp` should be used in that case to avoid accidental exposure of endpoints like `/metrics`, `/swagger`, etc |
| `public-whitelist` | This uses ingress controller `nginx-office` but sets a different list of allowed ip addresses than the default by using the `whitelist` parameter                                                                                                               |
| `esp`              | This creates a [Google Cloud Endpoint](https://cloud.google.com/endpoints), adds the esp sidecar container to the deployment and exposes it through a `LoadBalancer` service                                                                                    |
| `espv2`            | Sames as `esp` but uses the envoy-based version 2                                                                                                                                                                                                               |
| `iap`              | Sets up the application behind [Identity Aware Proxy](https://cloud.google.com/iap); requires parameters `iapOauthClientID` and `iapOauthClientSecret` to be set                                                                                                |
| `apigee`           | Routes requests through the `nginx-open` ingress controller; requires parameters `request.authsecret` and `request.verifydepth` to be set                                                                                                                       |

Note: all of the above set up an internal ingress if parameter `internalhosts` is set; for esp this cannot be used to connect to the application since internally since it's limited to only a single hostname
