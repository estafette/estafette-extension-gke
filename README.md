# Estafette CI GKE extension

This extension makes it easy to deploy an application to GKE, and automatically handles getting the right credentials, implementing a number of best practices and more.

* [Usage](#usage)
* [Parameters](#parameters)
* [Visibility](#visibility)

# Usage

To use it you can pass a minimal number of parameters and have it create a deployment for you.

```yaml
releases:
  dev:
    stages:
      deploy:
        image: extensions/gke:stable
        container:
          repository: extensions
        hosts:
        - gke.estafette.io
```

But there's many more parameters to control the kind of resource it creates - deployment, cronjob, job, statefulset - and many other things to tune.

# Parameters

## Global parameters

| Parameter                 | Allowed values                                                                                                                                                          | Default value                                                      | Description                                                                                                         |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------| -------------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `action`                  | `deploy-simple`, `deploy-canary`, `deploy-stable`, `restart-simple`, `restart-canary`, `restart-stable`, `diff-simple`, `diff-canary`, `diff-stable`, `rollback-canary` | `deploy-simple`                                                    | Controls what action is taken; can take values from Estafette release actions                                       |
| `kind`                    | `deployment`, `headless-deployment`, `statefulset`, `job`, `cronjob`, `config`, `config-to-file`                                                                        | `deployment`                                                       | Determines the type of Kubernetes resource to get created                                                           |
| `dryrun`                  | boolean                                                                                                                                                                 | false                                                              | Controls whether the changes generated by this extension will be applied                                            |
| `app`                     | string                                                                                                                                                                  | `${ESTAFETTE_LABEL_APP}` if set, `${ESTAFETTE_GIT_NAME}` otherwise | The name used to deploy the application                                                                             |
| `namespace`               | string                                                                                                                                                                  | empty, but usually set in the credential defaults                  | Sets the kubernetes namespace to deploy to                                                                          |

Note: the `action` should preferably not be set directly on the stage, but as actions on the stage, so you can trigger every action from estafette using the same stage:

```yaml
releases:
  prd:
    actions:
    - name: deploy-canary
    - name: deploy-stable
    - name: rollback-canary
      hideBadge: true
    - name: restart-stable
      hideBadge: true
    stages:
      deploy:
        image: extensions/gke:stable
        kind: deployment
```

## Deployment parameters

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `replicas`                | int                                                                                                                                                 | 1                                                              | The number of pods to run                                                                                           |
| `visibility`              | `private`, `public`, `public-whitelist`, `esp`, `espv2`, `iap`, `apigee`                                                                            | `private`                                                      | Determines how the application can be reached                                                                       |
| `iapOauthClientID`        | base64 encoded string                                                                                                                               |                                                                | Needs a Google OAuth Client ID encoded in base64 when using `visibility: iap`; has to be created in advance         |
| `iapOauthClientSecret`    | base64 encoded string                                                                                                                               |                                                                | Needs a Google OAuth Client Secret encoded in base64 when using `visibility: iap`; has to be created in advance     |
| `espEndpointsProjectID`   | project id                                                                                                                                          |                                                                | When Google Cloud Endpoints are set up in a centralized project set it's ID with this parameter                     |
| `espConfigID`             | string                                                                                                                                              | takes the latest openapi spec uploaded by this extension       | When you want to pin the version of the openapi spec uploaded as a Google Cloud Endpoint config it can be set       |
| `espOpenapiYamlPath`      | path                                                                                                                                                |                                                                | Path to `openapi.yaml` file to use for creating the endpoint config; use separate ones per environment              |
| `whitelist`               | array of CIDRs                                                                                                                                      | the default configured in the `nginx-office` controller        | A list of [CIDRs][https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing] to allow access to the application  |

Note: for `visibility: esp` a release needs access to the openapi spec, so combine with `clone: true` on the release target, for example:

```yaml
releases:
  dev:
    clone: true
    stages:
      deploy:
        image: extensions/gke:stable
        visibility: esp
        espOpenapiYamlPath: openapi.dev.yaml
```

## Statefulset parameters

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `storageclass`            | standard, pd-standard, pd-ssd                                                                                                                       | standard                                                       | Determines the type of persistent disk created                                                                      |
| `storagesize`             | string (1Gi)                                                                                                                                        | 1Gi                                                            | The size of the persistent disk                                                                                     |
| `storagemountpath`        | string                                                                                                                                              | /data                                                          | The path where the persistent disk is mounted                                                                       |

## Cronjob parameters

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `schedule`                | an expression in cron format                                                                                                                        |                                                                | Sets the schedule at which the cronjob spawns a new job                                                             |
| `concurrencypolicy`       | Allow, Forbid                                                                                                                                       | Allow                                                          | Indicates whether concurrent jobs are allowed or forbidden                                                          |

## Job parameters

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `completions`             | an expression in cron format                                                                                                                        |                                                                |                                                                                                                     |
| `parallelism`             | an expression in cron format                                                                                                                        |                                                                |                                                                                                                     |
| `backoffLimit`            | an expression in cron format                                                                                                                        |                                                                |                                                                                                                     |

## Pod parameters

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `restartPolicy`           | Always, OnFailure                                                                                                                                   | OnFailure                                                      | Controls whether a container should be restarted when it stops                                                      |

## Miscellaneous parameters

| Parameter                 | Allowed values                                                                                                                                      | Default value                                                  | Description                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------| ---------------------------------------------------------------| ------------------------------------------------------------------------------------------------------------------- |
| `progressDeadlineSeconds` | int                                                                                                                                                 | 600                                                            | Sets the number of seconds for Kubernetes to wait for a deployment to lack progress before treating it as a failure |
| `os`                      | linux, windows                                                                                                                                      | linux                                                          | The operating system to deploy to                                                                                   |
| `chaosproof`              | boolean                                                                                                                                             | false                                                          | Determines whether it's okay to run the application on preemptibles                                                 |

TODO:

```
manifests
trustedips
labels
containerNativeLoadBalancing
hosts
hostsrouteonly
internalhosts
internalhostsrouteonly
apigeesuffix
basepath
autoscale
request
secrets
configs
volumemounts
certificatesecret
allowhttp
enablePayloadLogging
useGoogleCloudCredentials
disableServiceAccountKeyRotation
legacyGoogleCloudServiceAccountKeyFile
googleCloudCredentialsApp
probeService
tolerations
container
injecthttpproxysidecar
initcontainers
sidecar
sidecars
customsidecars
strategytype
rollingupdate
defaultOpenrestySidecarImage
defaultESPSidecarImage
defaultESPv2SidecarImage
defaultCloudSQLProxySidecarImage
imagePullSecretUser
imagePullSecretPassword
```

# Visibility

How the customers of an application - whether it's an actual user connecting or another service - can communicate with your application is set by the `visibility` parameter. 

| Value              | Description                                                                                                                                                                                                                                                     |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `private`          | A Kubernetes service of type `ClusterIP` is created and depending on the values for `hosts` and `internalhosts` it also sets up ingresses using ingress class `nginx-office` and/or `nginx-internal`                                                            |
| `public`           | A `LoadBalancer` Kubernetes service is created which gives direct public access to the application; this is no longer allowed for new deployments, `esp` should be used in that case to avoid accidental exposure of endpoints like `/metrics`, `/swagger`, etc |
| `public-whitelist` | This uses ingress controller `nginx-office` but sets a different list of allowed ip addresses than the default by using the `whitelist` parameter                                                                                                               |
| `esp`              | This creates a [Google Cloud Endpoint][https://cloud.google.com/endpoints], adds the esp sidecar container to the deployment and exposes it through a `LoadBalancer` service                                                                                    |
| `espv2`            | Sames as `esp` but uses the envoy-based version 2                                                                                                                                                                                                               |
| `iap`              | Sets up the application behind [Identity Aware Proxy][https://cloud.google.com/iap]; requires parameters `iapOauthClientID` and `iapOauthClientSecret` to be set                                                                                                |
| `apigee`           | Routes requests through the `nginx-open` ingress controller; requires parameters `request.authsecret` and `request.verifydepth` to be set                                                                                                                       |

Note: all of the above set up an internal ingress if parameter `internalhosts` is set; for esp this cannot be used to connect to the application since internally since it's limited to only a single hostname
